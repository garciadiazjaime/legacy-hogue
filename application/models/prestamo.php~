<?php
class Prestamo extends CI_Model {
    
    public $Html = "";
    public $TRegistros = "";
    public $periodo_id = 1;
    public $InfoPaginado = array();
    public $estatus = array( "0" => "Inactivo",
                             "1" => "Activo",
                             "2" => "Standby",
                             "3" => "Cerrado" );

    function __construct() {
        parent::__construct();
        $this->load->model('user');
        $this->load->model('controluser');
    }

    public function _get_prestamos(){
        $_info = $_POST;
        $_Inicio = 0;
        $_Pactua = 1;
        $_OrdenBy = "P.id DESC";
        $_Where = array();
        $_Nregistros = 10;
        $_InfoWhere = "";
        $_CpoInner = array();
        $_InfoInner = "";
        $_Order = array( "1-desc" => "U.no_emp DESC",
                         "1-asc" => "U.no_emp ASC",
                         "2-desc" => "U.name DESC",
                         "2-asc" => "U.name ASC",
                         "3-desc" => "P.monto_total DESC",
                         "3-asc" => "P.monto_total ASC",
                         "4-desc" => "P.interes DESC",
                         "4-asc" => "P.interes ASC",
                         "5-desc" => "P.plazo DESC",
                         "5-asc" => "P.plazo ASC",
                         "6-desc" => "P.status DESC",
                         "6-asc" => "P.status ASC" );

        if(isset($_info['campo']) && $_info['campo'] != "" ){
            $_OrdenBy = $_Order[ $_info['campo'] ];
        }

        if( isset($_info['pagina']) && $_info['pagina'] != 0 ){
            $_Inicio = ( $_info['pagina']-1 ) * $_Nregistros;
            $_Pactua = $_info['pagina'];
        }

        if(isset($_info['week_from']) && isset($_info['week_until']) && $_info['week_from'] != "0" AND $_info['week_until'] != "0" ){
            //$_Where[] = "P.week >= {$_info['week_from']} AND P.week <= {$_info['week_until']}";
        }

        if(isset($_info['loaned_from']) && isset($_info['loaned_until']) && $_info['loaned_from'] != "" AND $_info['loaned_until'] != "" ){
            $_Where[] = "P.monto_total >= {$_info['loaned_from']} AND P.monto_total <= {$_info['loaned_until']}";
        }

        if(isset($_info['payments_from']) && isset($_info['payments_from']) && $_info['payments_from'] != "" AND $_info['payments_until'] != "" ){
            $_Where[] = "P.plazo >= {$_info['payments_from']} AND P.plazo <= {$_info['payments_until']}";
        }

        if(isset($_info['loan_status']) && $_info['loan_status'] != "" ){
            $_Where[] = "P.status = {$_info['loan_status']}";
        }

        if( count( $_Where ) )
            $_InfoWhere = " WHERE ".  implode( " AND ", $_Where );

        if( isset($_info['employee_number']) && $_info['employee_number'] != "" ){
            $_CpoInner[] = " U.no_emp like '%".$_info['employee_number']."%'";
        }

        if(isset($_info['employee_name']) && $_info['employee_name'] != "" ){
            $_CpoInner[] = " U.name LIKE '%{$_info['employee_name']}%' ";
        }

        if( count( $_CpoInner ) > 0 )
            $_InfoInner = "AND ". implode( " AND ", $_CpoInner );

        $_InfoInner = " INNER JOIN user AS U ON P.user_id = U.id {$_InfoInner}";

        $_Query = "SELECT P.id FROM  prestamo AS P {$_InfoInner} {$_InfoWhere} ";
        $_InfoQuery = $this->db->query( $_Query );
        $this->TRegistros = $_InfoQuery->num_rows();

        $_Panterior = $_Pactua - 1;
        $_Psiguiente = $_Pactua + 1;
        $_Pultima = $this->TRegistros / $_Nregistros;
        $_Resultado = $this->TRegistros % $_Nregistros;
        if( $_Resultado > 0 ) $_Pultima = floor( $_Pultima ) + 1;

        if( $this->TRegistros == 0 )
            $_Pactua = 0;

        $this->InfoPaginado = array( "pactual" => $_Pactua,
                                     "panterior" => $_Panterior,
                                     "psiguiente" => $_Psiguiente,
                                     "pultima" => $_Pultima,
                                     "pinicio" => $_Pactua-3,
                                     "pfin" => $_Pactua+3 );

        $_Query = "SELECT P.id, 
                          P.monto_total, 
                          P.week, 
                          P.year, 
                          P.status, 
                          P.interes, 
                          P.user_id, 
                          P.periodo_id,
                          P.plazo,
                          U.no_emp,
                          U.name
                   FROM prestamo AS P {$_InfoInner} {$_InfoWhere} ORDER BY {$_OrdenBy} 
                   LIMIT ".$_Inicio.",".$_Nregistros;
        $_InfoQuery = $this->db->query( $_Query );
	if( isset($_info['pagina']) && $_info['pagina'] != 0 && $_info['employee_number'] = '')
        	echo $this->_set_lista_view( $_InfoQuery );
	else
        	return $this->_set_lista_view( $_InfoQuery );

    }

    public function _set_format_cantidad( $_Prestamo ){

        return "$ ".number_format( $_Prestamo, 2, ".",",");

    }
    
    public function _set_format_db( $_Prestamo ){

        return number_format( $_Prestamo, 2, ".","");

    }
    public function _set_lista_view( $_InfoQuery ){

        $this->Html = "";
        $this->Html .= '<p class="important_number">
                            <em>N&uacute;mero de pr&eacute;stamos:</em> <span id="nprestamos">'. $this->TRegistros .'</span>
                        </p>';
        $this->Html .= '<table>';

            $this->Html .= $this->_add_header_list();            

            $i = 0;
            if( $this->TRegistros != 0 )
                foreach ( $_InfoQuery->result() as $row ){

                    $i++;
                    $_class = ( $i % 2 ) ? "odd" : "pair";

                    $this->Html .= '<tr class="'. $_class .'">
                                        <td>
                                            '. $row->no_emp .'
                                        </td>
                                        <td>
                                            '. $row->name .'
                                        </td>
                                        <td>
                                            '. $this->_set_format_cantidad( $row->monto_total ) .'
                                        </td>
                                        <td>
                                            '. $this->_set_format_cantidad( $row->interes ) .'
                                        </td>
                                        <td>
                                            '. $row->plazo .' Semanas
                                        </td>
                                        <td>
                                            '. $this->estatus[ $row->status ] .'
                                        </td>
                                        <td>
                                            <a href=\''.base_url().'sistema/prestamos/ver/'.$row->id.'\' title=\'Ver m&aacute;s\' class=\'read_more\'>Ver +</a>
                                        </td>
                                    </tr>';

                }
            else
                $this->Html .= '<tr class="odd">
                                    <td colspan="7">
                                        No cuenta con registros para mostrar
                                    </td>
                                </tr>';

        $this->Html .= '</table>';
        $this->Html .= $this->_add_paginado();

        return $this->Html;

    }

    public function _add_paginado(){

        $_inicia = 1;
        $_termina = 0;

        if( $this->InfoPaginado['pinicio'] > 0 )
            $_inicia = $this->InfoPaginado['pinicio'];

        if( $this->InfoPaginado['pfin'] > $this->InfoPaginado['pultima'] )
            $_termina = $this->InfoPaginado['pultima'];
        else
            $_termina = $this->InfoPaginado['pfin'];

        $_Paginado = '<div class="pagination">';

        for( $i = $_inicia; $i <= $_termina; $i++ ){

            $_Paginado .= '<a href="#" onclick="FilePrestamos._set_muestra( '. $i .', \'\' )">';
                if( $i == $this->InfoPaginado['pactual'] )
                    $_Paginado .= '<span>['. $i .']</span>';
                else
                    $_Paginado .= $i;
            $_Paginado .= '</a>';

        }

        $_Paginado .= '</div>';

        return $_Paginado;

    }

    public function _add_header_list(){

        $_Header = '<tr>
                        <th class="column_id">
                            # Empleado 
                            <a href="#" title="Ordenar descendentemente" onclick="FilePrestamos._set_muestra( \'\', \'1-desc\' )" >
                                <img src="../resources/images/arrow_down.png" alt="&darr;" class="sort_arrow_desc" /> 
                            </a> 
                            <a href="#" title="Ordenar ascendentemente"  onclick="FilePrestamos._set_muestra( \'\', \'1-asc\' )">
                                <img src="../resources/images/arrow_up.png" alt="&uarr;" class="sort_arrow_asc" /> 
                            </a>
                        </th>
                        <th class="column_name">
                            <span>Nombre</span> 
                            <span class="sort_arrows"> 
                                <a href="#" title="Ordenar descendentemente" onclick="FilePrestamos._set_muestra( \'\', \'2-desc\' )" >
                                    <img src="../resources/images/arrow_down.png" alt="&darr;" class="sort_arrow_desc" /> 
                                </a> 
                                <a href="#" title="Ordenar ascendentemente"  onclick="FilePrestamos._set_muestra( \'\', \'2-asc\' )">
                                    <img src="../resources/images/arrow_up.png" alt="&uarr;" class="sort_arrow_asc" /> 
                                </a>
                            </span>
                        </th>
                        <th class="column_name">
                            <span>Monto prestado</span> 
                            <span class="sort_arrows"> 
                                <a href="#" title="Ordenar descendentemente" onclick="FilePrestamos._set_muestra( \'\', \'3-desc\' )" >
                                    <img src="../resources/images/arrow_down.png" alt="&darr;" class="sort_arrow_desc" /> 
                                </a> 
                                <a href="#" title="Ordenar ascendentemente"  onclick="FilePrestamos._set_muestra( \'\', \'3-asc\' )">
                                    <img src="../resources/images/arrow_up.png" alt="&uarr;" class="sort_arrow_asc" /> 
                                </a>
                            </span>
                        </th>
                        <th class="column_name">
                            <span>Interese</span> 
                            <span class="sort_arrows"> 
                                <a href="#" title="Ordenar descendentemente" onclick="FilePrestamos._set_muestra( \'\', \'4-desc\' )" >
                                    <img src="../resources/images/arrow_down.png" alt="&darr;" class="sort_arrow_desc" /> 
                                </a> 
                                <a href="#" title="Ordenar ascendentemente"  onclick="FilePrestamos._set_muestra( \'\', \'4-asc\' )">
                                    <img src="../resources/images/arrow_up.png" alt="&uarr;" class="sort_arrow_asc" /> 
                                </a>
                            </span>
                        </th>
                        <th class="column_plazo">
                            Plazo 
                            <a href="#" title="Ordenar descendentemente" onclick="FilePrestamos._set_muestra( \'\', \'5-desc\' )" >
                                <img src="../resources/images/arrow_down.png" alt="&darr;" class="sort_arrow_desc" /> 
                            </a> 
                            <a href="#" title="Ordenar ascendentemente"  onclick="FilePrestamos._set_muestra( \'\', \'5-asc\' )">
                                <img src="../resources/images/arrow_up.png" alt="&uarr;" class="sort_arrow_asc" /> 
                            </a>
                        </th>
                        <th class="column_estatus">
                            Estatus 
                            <a href="#" title="Ordenar descendentemente" onclick="FilePrestamos._set_muestra( \'\', \'6-desc\' )" >
                                <img src="../resources/images/arrow_down.png" alt="&darr;" class="sort_arrow_desc" /> 
                            </a> 
                            <a href="#" title="Ordenar ascendentemente"  onclick="FilePrestamos._set_muestra( \'\', \'6-asc\' )">
                                <img src="../resources/images/arrow_up.png" alt="&uarr;" class="sort_arrow_asc" /> 
                            </a>
                        </th>
                        <th class="column_view_more">&nbsp;</th>
                    </tr>';

        return $_Header;

    }
    
    public function _get_infoAhorrador( $_Id ){
        
        #Info es ahorrador        
        $_Query = "SELECT A.id,
                          A.monto
                   FROM ahorro AS A
                   WHERE A.user_id = '{$_Id}' AND 
                         A.status = 1";
                   
        $_InfoQuery = $this->db->query( $_Query );
        
        return $_InfoQuery->num_rows();
        
    }
    
    public function _get_infoPrestamos( $_Id ){
        
        #Info num prestamos
        $_Query = "SELECT P.id,
                          P.monto_total
                   FROM prestamo AS P
                   WHERE P.user_id = '{$_Id}' AND 
                         P.status = 1";
                   
        $_InfoQuery = $this->db->query( $_Query );
        
        return $_InfoQuery->num_rows();
        
    }
    
    public function _get_infoEmpleado(){
        
        $_info = $_POST;
        #Info nombre del empleado
        $_Query = "SELECT U.no_emp,
                          U.name,
                          U.id
                   FROM user AS U
                   WHERE U.no_emp = '{$_info['no_emp']}'";
                   
        $_InfoQuery = $this->db->query( $_Query );
        $_Empleado = $_InfoQuery->result();
                
        if( sizeof( $_Empleado ) ) {      
            
            $_Tasa = 0;
            $_Ahorrador = $this->_get_infoAhorrador($_Empleado[0]->id);
            $_Nprestamos = $this->_get_infoPrestamos($_Empleado[0]->id);
            
            if( $_Ahorrador != 0 )
                $_Tasa = 10;
            else 
                $_Tasa = 15;
            
            return "{$_Empleado[0]->name}|{$_Tasa}|{$_Nprestamos}|{$_Empleado[0]->id}";
            
        } else {            
            return '';            
        }
    }
      
    public function _save_prestamos(){
    
        $_info = $_POST;
        
        $_iva = $_info['loan'] * ( $_info['porcentaje'] / 100 ) ;
        $_total = $_info['loan'] + $_iva;
        $_parcialidades = $_total / $_info['weeks_payment'];
        $_info['usrid'] = $this->controluser->userExists(
		$_info['employee_number'], $_info['employee_name']);
        if( $_info['usrid'] == "" || $_info['usrid'] == 0){
            $_info['usrid'] = $this->user->create( $_info['employee_number'], 
                                                   $_info['employee_name'] );
        }
        
        $_prestamo = array( "monto_prestado" => "{$this->_set_format_db($_info['loan'])}",
                            "monto_total" => "{$this->_set_format_db($_total)}",
                            "monto_pago" => "{$this->_set_format_db($_parcialidades)}",
                            "plazo" => "{$_info['weeks_payment']}",
                            "interes" => "{$this->_set_format_db($_iva)}",
                            "week" => "{$_info['saving_starts']}",
                            "year" => date("Y"),
                            "status" => "1",
                            "user_id" => "{$_info['usrid']}",
                            "periodo_id" => "1" );
                               
        if( $this->db->insert( 'prestamo', $_prestamo ) )
            return 'Registro insertado de manera exitosa.';
        else 
            return 'Hubo un error al insertar el registro.';
    }
    
    public function _update_prestamos($id){
    
        $_info = $_POST;
        $_iva = $_info['loan'] * ( $_info['porcentaje'] / 100 ) ;
        $_total = $_info['loan'] + $_iva;
        $_parcialidades = $_total / $_info['weeks_payment'];
        
        if( $_info['usrid'] == "" ){
            $_info['usrid'] = $this->user->create( $_info['employee_number'], 
                                                   $_info['employee_name'] );
        }
        
        $_prestamo = array( "monto_prestado" => "{$this->_set_format_db($_info['loan'])}",
                            "monto_total" => "{$this->_set_format_db($_total)}",
                            "monto_pago" => "{$this->_set_format_db($_parcialidades)}",
                            "plazo" => "{$_info['weeks_payment']}",
                            "interes" => "{$this->_set_format_db($_iva)}",
                            "week" => "{$_info['saving_starts']}",
                            "year" => date("Y"),
                            "status" => "1",
                            "user_id" => "{$_info['usrid']}",
                            "periodo_id" => "1" );
        $this->db->where('id', $id);                       
        if( $this->db->update( 'prestamo', $_prestamo ) )
            return 'Registro actualizado de manera exitosa.';
        else 
            return 'Hubo un error al insertar el registro.';
    }

    function getUserId($id)
    {
		$query = $this->db->query("select user_id from prestamo where id = ".$id);
		if ($query->num_rows() > 0)
		{
			return $query->row()->user_id;
		}
		return false;
    }
}
