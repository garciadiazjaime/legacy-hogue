<?php

class Nomina extends CI_Model{

	function __construct()
	{
		parent::__construct();
	}

	function isWeekRegistered($week)
	{
		$periodo_obj = $this->controlperiodo->getCurrentPeriodo();
		$query = $this->db->query("SELECT ifnull(status,0) as status FROM nomina WHERE week = ".$week." AND periodo_id = ".$periodo_obj->id);
		if ($query->num_rows() > 0)
			return true;
		return false;
	}

	function registrarPrestamos($week)
	{
		$periodo_obj = $this->controlperiodo->getCurrentPeriodo();
		$sql_prestamo = "
		SELECT monto_pago, year, status, id
			FROM prestamo
			WHERE year = '".date('Y')."'
				AND (status =1 OR status =2)";
		$prestamos = $this->db->query($sql_prestamo);		
		if ($prestamos->num_rows() > 0)
		{
			foreach ($prestamos->result() as $row)
			{
				$prestamos_registro = array(
					'monto' => $row->monto_pago,
					'week' => $week,
					'year' => $row->year,
					'status' => $row->status,
					'prestamo_id' => $row->id
				);
				$this->db->insert('prestamo_registro',$prestamos_registro);
			}
		}
	}

	function registrarAhorro($week)
	{
		$sql_ahorro = "
		SELECT monto, year, status, id
			FROM ahorro
			WHERE (status =1 OR status =2)
				AND year = '".date('Y')."'
			";
		$ahorros = $this->db->query($sql_ahorro); 
		if ($ahorros->num_rows() > 0)
		{
			foreach ($ahorros->result() as $row)
			{
				$ahorro_registro = array(
					'monto' => $row->monto,
					'week' => $week,
					'year' => $row->year,
					'status' => $row->status,
					'ahorro_id' => $row->id
				);
				$this->db->insert('ahorro_registro',$ahorro_registro);
			}
		}
	}

	function registrarNomina($week)
	{
		$registrado = false;

		if(!$this->isWeekRegistered($week))
		{
			$periodo_obj = $this->controlperiodo->getCurrentPeriodo();
			$this->registrarAhorro($week);
			$this->registrarPrestamos($week);
			$nomina_registro = array(
						'week' => $week,
						'status' => 1,
						'periodo_id' => $periodo_obj->id
					);
			if($this->db->insert('nomina',$nomina_registro))
				$registrado = true;
			else
				$registrado = false;
		}
		else
			$registrado = false;

		return $registrado;
	}

	function executeNomina($week,$week_is_registered)
	{
		$filters = $_POST;
		$response = $clas = $prestamo = $pagination = $sql = $msg = '';
		$i = $no = 1;
		$emp_per_page = 10;
		$i = 1;
		$descontar = $ahorro = 0;
		$page = 1;
		if(!empty($filters['page'])) $page = $filters['page'];
		$keepOrderby = 0;
		$sql = "
		SELECT DISTINCT (u.id)
			FROM user u
			LEFT JOIN ahorro a ON u.id = a.user_id
			LEFT JOIN prestamo p ON u.id = p.user_id
			WHERE (
				(a.status =1 OR a.status =2)
				AND a.year = '".date('Y')."'
			)
			OR (
				p.year = '".date('Y')."'
				AND (p.status =1 OR p.status =2)
			)
			AND u.status =1";
		$query = $this->db->query($sql);
		$no_empleados = $query->num_rows;
		$no_pages = ceil($no_empleados / $emp_per_page);
		$from = $emp_per_page * ($page - 1);
		
		$sql = ($week_is_registered) ? "
		SELECT u.id, u.no_emp, u.name, IFNULL( ar.monto, 0 ) as amonto
		FROM ahorro_registro ar
		LEFT JOIN ahorro a ON a.id = ar.ahorro_id
		LEFT JOIN user u ON u.id = a.user_id
		WHERE ar.week = ".$week."
		GROUP BY u.id
		LIMIT ".$from.",".$emp_per_page
		:		
		"
		SELECT u.id, u.no_emp, u.name, ifnull(a.monto,0) as amonto, a.status as status 
			FROM user u
			LEFT JOIN ahorro a
			ON u.id = a.user_id
				AND (a.status = 1 OR a.status = 2 )
				AND a.year = '".date('Y')."'
				AND u.status = 1
			ORDER BY u.no_emp
		LIMIT ".$from.",".$emp_per_page;
		$query = $this->db->query($sql);
		if ($query->num_rows() > 0)
		{
			foreach ($query->result() as $row)
			{
				$prestamo = '';
				$descontar = 0;
				$descontar += $row->amonto;
				$sql = "SELECT ifnull(monto,0) as monto FROM prestamo_registro pr
					LEFT JOIN prestamo p ON p.id = pr.prestamo_id
					LEFT JOIN user u ON u.id = p.user_id
					WHERE pr.week = ".$week."
					AND u.id = ".$row->id;
				$query2 = $this->db->query($sql);
				$ahorro = $row->amonto;
				if($query2->num_rows())
				{
					foreach ($query2->result() as $row2)
					{
						$prestamo .= "<span class=\"loans_info\">$".number_format(round($row2->monto, 2), 2, '.', ' ')."</span>";
						$descontar += $row2->monto;
					}
				}
				if(empty($row->amonto) && empty($prestamo)) continue;
				$class = ($i++ % 2 == 0) ? 'odd' : '';
				$response .= "
				<tr class=\"".$class."\">
				<td>".$row->no_emp."</td>
				<td>".$row->name."</td>
				<td class=\"money\">$".number_format(round($ahorro,2), 2, '.',' ')."</td>
				<td >".$prestamo."</td>
				<td>$".number_format(round($descontar,2), 2, '.', ' ')."</td>
				</tr>
				";
			}
			if(!empty($response))
			{
			if($no_empleados > $emp_per_page)
			{
				for($i=1; $i <= $no_pages; $i++)
				{
					$pagination .= ($i == $page) ?
					"<a href=\"?page=$i\" onclick=\"getReporteNominas($i,$week); return false\"><span>[".$i."]</span></a>-":
					"<a href=\"?page=$i\" onclick=\"getReporteNominas($i,$week); return false\" >".$i."</a>-";
				}
				if(!empty($pagination)){
					$pagination = substr($pagination, 0, strrpos($pagination, '-'));
					$pagination = "<div class=\"pagination\">$pagination</div>";
				}
			}

				if($week_is_registered)
					$msg =  "La semana ya ha sido registrada.";
				else
					$msg =  "<button type=\"button\" value=\"guardar\" onclick=\"registrarNomina(".$week.");\">Guardar N&oacute;mina</button> ";
				$response =
				"<table class=\"report_table\">
				<tr>
				<th class=\"column_report_id_employee\"><span># Empleado</span></th>
				<th class=\"column_report_employee_name\"><span>Nombre</span></th>
				<th class=\"column_report_savings\"><span>Ahorro</span></th>
				<th class=\"column_report_loans\"><span>Pr&eacute;stamos</span></th>
				<th class=\"column_report_total_loans\"><span>Monto a descontar</span></th>
				</tr>
				$response
				</table>
				$pagination
				";
			}
		}
		return $msg.$response;
	}//executeNomina
	
	function executeNominaExcel($week)
	{
		$this->load->library('PHPExcel');
		$objPHPExcel = new PHPExcel();
		$rowNumber = 1;
		$headings = array('No Emp','Nombre','Total');
		$objPHPExcel->getActiveSheet()->fromArray(array($headings),NULL,'A'.$rowNumber);

		$rowNumber += 1;

		$sql = "SELECT u.no_emp AS No_Emp, u.name AS Nombre, (
			IFNULL( pr.monto, 0 ) + IFNULL( ar.monto, 0 )
			) AS Total
			FROM user u
			LEFT JOIN ahorro_registro ar ON ar.week = ".$week."
			LEFT JOIN prestamo_registro pr ON pr.week =".$week."
			LEFT JOIN ahorro a ON a.id = pr.prestamo_id
			AND a.user_id = u.id
			LEFT JOIN prestamo p ON p.id = pr.prestamo_id
			AND p.user_id = u.id
			WHERE (
			(
			ar.week =".$week."
			)
			AND a.year = '".date('Y')."'
			)
			OR (
			p.year = '".date('Y')."'
			AND (
			pr.week =".$week."
			)
			)
			GROUP BY u.id";
		$query = $this->db->query($sql);

		if ($query->num_rows() > 0)
		{
			
			foreach ($query->result() as $row)
			{
				$col = 'A';
				foreach ($row as $cell)
				{
					$objPHPExcel->getActiveSheet()->setCellValue(
						$col.$rowNumber,$cell);
					$col++;
				}
				$rowNumber += 1;
			}
			$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');

			header('Content-Type: application/vnd.ms-excel');
			header('Content-Disposition: attachment;filename="nomina_semanal_'.$week.'.xls"');
			header('Cache-Control: max-age=0');

			return $objWriter->save('php://output');
		}
		else
			return false;

		
		//exit();
	}//executeNominaExcel

}
