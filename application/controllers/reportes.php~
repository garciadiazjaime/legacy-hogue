<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Reportes extends CI_Controller {

	/**
	 * Index Page for this controller.
	 *
	 * Maps to the following URL
	 * 		http://example.com/index.php/welcome
	 *	- or -
	 * 		http://example.com/index.php/welcome/index
	 *	- or -
	 * Since this controller is set as the default controller in
	 * config/routes.php, it's displayed at http://example.com/
	 *
	 * So any other public methods not prefixed with an underscore will
	 * map to /index.php/welcome/<method_name>
	 * @see http://codeigniter.com/user_guide/general/urls.html
	 */
	public function __construct()
	{
		parent::__construct();
		$this->load->helper('url');
		$this->load->database();
		$this->load->model('periodo');
		$this->load->model('ahorro');
		$this->load->model('user');
		$this->load->model('controlperiodo');
		$this->load->model('controluser');
		$this->load->model('controlahorro');
		$this->load->model('nomina');
		$this->load->model('reporte');
		$this->load->model('prestamo');
		$this->load->library('session');
		$this->load->library('user_agent');
		$this->load->library('miscellaneous');
		$this->is_logged_in();
		$this->clear_cache();
	}

	public function is_logged_in()
	{
		if ($this->session->userdata('is_logged') != 'true'
			&& uri_string() != 'sistema/login')
		{
     		redirect(base_url().'sistema/login', 'refresh');
		}
	}	

	function clear_cache()
	{
        	$this->output->set_header("Cache-Control: no-store, no-cache, must-revalidate, no-transform, max-age=0, post-check=0, pre-check=0");
	        $this->output->set_header("Pragma: no-cache");
	}

	public function index()
	{
		$resumen = $report_week = "";
		if(sizeof($_POST))
		{
			$report_week = isset($_POST['report_week']) ? $_POST['report_week'] : '';
			if(!empty($report_week))
			{

					$resumen = $this->reporte->general($report_week);
			}

		}
		$content = $this->load->view('be/reportes/main', array('resumen'=>$resumen,
			'report_week'=>$report_week), true);
		$this->load->view('be/layout/main', array('content'=>$content));
	}

	public function nomina()
	{
		$week_is_registered = false;
		$resumen = $report_week = "";
		if(sizeof($_POST))
		{
			$report_week = isset($_POST['report_week']) ? $_POST['report_week'] : '';
			if(!empty($report_week))
			{
				if(!$this->nomina->isWeekRegistered($report_week))
				{
	
					$resumen = $this->nomina->executeNomina(
						$report_week,
						$week_is_registered);
				}else
				{
					$week_is_registered = true;
					$resumen = $this->nomina->executeNomina(
						$report_week,
						$week_is_registered);
				}
			}

		}
		$content = $this->load->view('be/reportes/nomina', array('resumen'=>$resumen,
			'report_week'=>$report_week,'week_is_registered'=>$week_is_registered), true);
		$this->load->view('be/layout/main', array('content'=>$content));
	}

	public function ahorros()
	{
		$banco = 0;
		$msg = '';
		$ahorradores = '';
		if(sizeof($_POST))
		{
			$banco = isset($_POST['banco']) ? $_POST['banco'] : 0;
			if($banco <= 0)
			{
				$msg = 'Favor de ingresar un monto vÃ¡lido.';
				$ahorradores = $this->reporte->ahorros();
			}
		}
		$content = $this->load->view('be/reportes/ahorros', array('msg'=>$msg,'ahorradores'=>$ahorradores), true);
		$this->load->view('be/layout/main', array('content'=>$content));
	}

	public function excel(){
		$this->load->view('be/reportes/excel', '', true);
	}

	public function getReporteNominas()
	{
		$report_week = $resumen = "";
		$week_is_registered = false;
		if(sizeof($_POST))
		{
			$week_is_registered = isset($_POST['week_is_registered']) ? $_POST['week_is_registered'] : false;
			$report_week = isset($_POST['report_week']) ? $_POST['report_week'] : '';
			if(!empty($report_week))
			{
				$resumen = $this->nomina->executeNomina(
					$report_week,
					$week_is_registered);
			}

		}
		echo $resumen;
	}

	public function registrarNomina($week)
	{
		if(sizeof($_POST))
		{
			
			$report_week = isset($_POST['report_week']) ? $_POST['report_week'] : '';
			if(!empty($report_week))
			{
				$week = $report_week;
				$week_is_registered = $this->nomina->isWeekRegistered($week);
			}

		}
		else
			$week_is_registered = $this->nomina->registrarNomina($week);
		
		$resumen = $this->nomina->executeNomina($week,$week_is_registered);

		$content = $this->load->view('be/reportes/nomina', array('resumen'=>$resumen,
			'report_week'=>$week,'week_is_registered'=>$week_is_registered), true);
		$this->load->view('be/layout/main', array('content'=>$content));
	}

	public function getNominaExcel($week)
	{
		return $this->nomina->executeNominaExcel($week);
	}
	
	public function getReporteGeneral()
	{
		if(sizeof($_POST))
		{
			
			$report_week = isset($_POST['report_week']) ? $_POST['report_week'] : '';
		if(!empty($report_week))
			{
				return $this->reporte->general($report_week);
			}
		}
	}
}

/* End of file welcome.php */
/* Location: ./application/controllers/welcome.php */
